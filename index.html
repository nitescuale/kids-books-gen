<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bedtime Stories</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&display=swap');   

        :root {
            /* Vibrant Family-Friendly Color Palette */
            --coral-100: #fef7ee;
            --coral-200: #fed7aa;
            --coral-300: #fdba74;
            --coral-400: #fb923c;
            --coral-500: #f97316;
            --coral-600: #ea580c;
            
            --ocean-100: #e0f2fe;
            --ocean-200: #bae6fd;
            --ocean-300: #7dd3fc;
            --ocean-400: #38bdf8;
            --ocean-500: #0ea5e9;
            --ocean-600: #0284c7;
            
            --lavender-100: #f3e8ff;
            --lavender-200: #e9d5ff;
            --lavender-300: #d8b4fe;
            --lavender-400: #c084fc;
            --lavender-500: #a855f7;
            --lavender-600: #9333ea;
            
            --mint-100: #dcfce7;
            --mint-200: #bbf7d0;
            --mint-300: #86efac;
            --mint-400: #4ade80;
            --mint-500: #22c55e;
            --mint-600: #16a34a;
            
            --sunshine-100: #fef3c7;
            --sunshine-200: #fde68a;
            --sunshine-300: #fcd34d;
            --sunshine-400: #fbbf24;
            --sunshine-500: #f59e0b;
            --sunshine-600: #d97706;
            
            --rose-100: #ffe4e6;
            --rose-200: #fecdd3;
            --rose-300: #fda4af;
            --rose-400: #fb7185;
            --rose-500: #f43f5e;
            --rose-600: #e11d48;
            
            --warm-white: #fffdf7;
            --warm-gray-100: #f5f5f4;
            --warm-gray-200: #e7e5e4;
            --warm-gray-300: #d6d3d1;
            --warm-gray-600: #57534e;
            --warm-gray-700: #44403c;
            --warm-gray-800: #292524;
            --warm-gray-900: #1c1917;
            
            /* Enhanced Shadows */
            --shadow-magical: 0 8px 32px rgba(251, 146, 60, 0.3);
            --shadow-dreamy: 0 16px 64px rgba(168, 85, 247, 0.4);
            --shadow-soft: 0 4px 24px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 40px rgba(0, 0, 0, 0.12);
            --shadow-large: 0 24px 80px rgba(0, 0, 0, 0.16);
            
            /* Friendly Border Radius */
            --radius-sm: 16px;
            --radius-md: 24px;
            --radius-lg: 32px;
            --radius-xl: 40px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: var(--warm-gray-800);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Optimized Static Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, 
                #fef3c7 0%, 
                #fed7aa 20%, 
                #e0f2fe 40%, 
                #f3e8ff 60%, 
                #dcfce7 80%, 
                #ffe4e6 100%
            );
            z-index: -3;
        }

        /* Optimized Static Orbs */
        .floating-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(60px);
            opacity: 0.4;
            z-index: -2;
        }

        .orb-1 {
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, var(--coral-300), var(--rose-300));
            top: 15%;
            left: 15%;
        }

        .orb-2 {
            width: 180px;
            height: 180px;
            background: radial-gradient(circle, var(--ocean-300), var(--lavender-300));
            top: 65%;
            right: 15%;
        }

        .orb-3 {
            width: 160px;
            height: 160px;
            background: radial-gradient(circle, var(--mint-300), var(--sunshine-300));
            bottom: 25%;
            left: 25%;
        }

        /* Optimized Glass Overlay */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            backdrop-filter: blur(20px);
            background: rgba(255, 253, 247, 0.2);
            z-index: -1;
        }

        .app {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 3px;
            background: linear-gradient(135deg, 
                var(--coral-400), 
                var(--sunshine-400), 
                var(--mint-400), 
                var(--ocean-400), 
                var(--lavender-400), 
                var(--rose-400)
            );
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-dreamy);
            position: relative;
        }

        .header-inner {
            padding: 3rem 2rem;
            background: rgba(255, 253, 247, 0.9);
            backdrop-filter: blur(20px);
            border-radius: calc(var(--radius-xl) - 3px);
        }

        .header h1 {
            font-size: 4rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, 
                var(--coral-500), 
                var(--rose-500), 
                var(--lavender-500), 
                var(--ocean-500), 
                var(--mint-500),
                var(--sunshine-500)
            );
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleShimmer 4s ease infinite;
        }

        @keyframes titleShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header p {
            font-size: 1.4rem;
            color: var(--warm-gray-600);
            font-weight: 500;
            max-width: 700px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            gap: 2.5rem;
            max-width: 600px;
            margin: 0 auto;
        }

        .section {
            background: linear-gradient(135deg, var(--section-header-start), var(--section-header-end));
            border-radius: var(--radius-lg);
            padding: 3px;
            box-shadow: var(--shadow-medium);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .section-inner {
            background: linear-gradient(135deg, var(--section-bg-start, rgba(255, 253, 247, 0.95)) 0%, var(--section-bg-end, rgba(255, 255, 255, 0.9)) 100%);
            backdrop-filter: blur(20px);
            border-radius: calc(var(--radius-lg) - 2px);
            overflow: hidden;
            position: relative;
            margin: -1px;
        }

        .section-content {
            padding: 2rem;
            background: transparent;
            position: relative;
            z-index: 1;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, var(--section-header-start), var(--section-header-end));
            border-radius: calc(var(--radius-lg) - 2px) calc(var(--radius-lg) - 2px) 0 0;
            margin: 0;
        }

        .section:hover {
            transform: translateY(-4px) scale(1.01);
            box-shadow: var(--shadow-large);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: white;
            letter-spacing: -0.01em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .section-icon {
            width: 3rem;
            height: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        padding: 0.5rem;
        }

        .settings .section-icon {
            padding: 0;
        }

        .section-icon img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .refresh-btn span {
            display: inline-flex;
            align-items: center;
            vertical-align: middle;
        }

        .refresh-btn span img {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
        }

        .characters {
            --section-header-start: var(--coral-400);
            --section-header-end: var(--rose-400);
            --section-bg-start: rgba(255, 253, 247, 0.95);
            --section-bg-end: rgba(255, 255, 255, 0.9);
        }

        .characters.has-selection {
            --section-bg-start: rgba(252, 234, 234, 0.95);
            --section-bg-end: rgba(253, 242, 242, 0.9);
        }

        .settings {
            --section-header-start: var(--ocean-400);
            --section-header-end: var(--lavender-400);
            --section-bg-start: rgba(255, 253, 247, 0.95);
            --section-bg-end: rgba(255, 255, 255, 0.9);
        }

        .settings.has-selection {
            --section-bg-start: rgba(224, 242, 254, 0.95);
            --section-bg-end: rgba(238, 247, 255, 0.9);
        }

        .lessons {
            --section-header-start: var(--mint-400);
            --section-header-end: var(--sunshine-400);
            --section-bg-start: rgba(255, 253, 247, 0.95);
            --section-bg-end: rgba(255, 255, 255, 0.9);
        }

        .lessons.has-selection {
            --section-bg-start: rgba(220, 252, 231, 0.95);
            --section-bg-end: rgba(236, 253, 243, 0.9);
        }

        .refresh-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 253, 247, 0.9));
            backdrop-filter: blur(10px);
            color: var(--warm-gray-700);
            border: 1px solid rgba(255, 255, 255, 0.8);
            border-radius: var(--radius-sm);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 1), rgba(255, 253, 247, 1));
            border-color: var(--coral-300);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .options-grid {
            display: grid;
            gap: 1rem;
            padding-top: 1.5rem;
        }

        .option-card {
            position: relative;
            padding: 1.25rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 253, 247, 0.8) 100%);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            line-height: 1.5;
            color: var(--warm-gray-700);
            font-weight: 500;
            min-height: 80px;
            display: flex;
            align-items: center;
        }

        .option-card:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 1) 0%, rgba(255, 253, 247, 0.95) 100%);
            border-color: var(--card-hover-border, var(--coral-400));
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px) scale(1.02);
        }

        .option-card.selected {
            background: linear-gradient(135deg, var(--card-selected-bg-start), var(--card-selected-bg-end));
            border-color: var(--card-selected-border);
            color: var(--warm-gray-800);
            box-shadow: var(--shadow-large);
            font-weight: 600;
            transform: translateY(-4px) scale(1.02);
        }

        .option-card.selected::after {
            content: '‚ú®';
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            font-size: 1.5rem;
            animation: sparkleRotate 3s ease infinite;
        }

        @keyframes sparkleRotate {
            0% { opacity: 1; transform: scale(1) rotate(0deg); }
            50% { opacity: 0.7; transform: scale(1.2) rotate(180deg); }
            100% { opacity: 1; transform: scale(1) rotate(360deg); }
        }

        .characters .option-card:hover {
            --card-hover-border: var(--coral-400);
        }

        .characters .option-card.selected {
            --card-selected-bg-start: var(--coral-100);
            --card-selected-bg-end: var(--rose-100);
            --card-selected-border: var(--coral-500);
        }

        .settings .option-card:hover {
            --card-hover-border: var(--ocean-400);
        }

        .settings .option-card.selected {
            --card-selected-bg-start: var(--ocean-100);
            --card-selected-bg-end: var(--lavender-100);
            --card-selected-border: var(--ocean-500);
        }

        .lessons .option-card:hover {
            --card-hover-border: var(--mint-400);
        }

        .lessons .option-card.selected {
            --card-selected-bg-start: var(--mint-100);
            --card-selected-bg-end: var(--sunshine-100);
            --card-selected-border: var(--mint-500);
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 4rem;
            color: var(--warm-gray-600);
            font-size: 1.2rem;
            font-weight: 600;
            font-style: italic;
        }

        .summary-section {
            background: linear-gradient(135deg, var(--mint-100) 0%, var(--ocean-100) 100%);
            backdrop-filter: blur(20px);
            border: 3px solid var(--mint-300);
            border-radius: var(--radius-xl);
            padding: 3rem;
            margin-top: 2.5rem;
            display: none;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-dreamy);
        }

        .summary-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(90deg, 
                var(--mint-400), 
                var(--ocean-400), 
                var(--lavender-400), 
                var(--mint-400)
            );
            background-size: 300% 100%;
            animation: summaryFlow 5s ease infinite;
        }

        @keyframes summaryFlow {
            0% { background-position: 0% 50%; }
            100% { background-position: 300% 50%; }
        }

        .summary-title {
            font-size: 2.25rem;
            font-weight: 800;
            color: var(--mint-600);
            margin-bottom: 2rem;
            text-align: center;
            letter-spacing: -0.01em;
            text-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .summary-grid {
            display: grid;
            gap: 1.5rem;
        }

        .summary-item {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 1.75rem;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-soft);
            border-left: 8px solid var(--mint-500);
            transition: all 0.3s ease;
        }

        .summary-item:hover {
            transform: translateX(8px);
            box-shadow: var(--shadow-medium);
        }

        .summary-label {
            font-size: 1rem;
            font-weight: 700;
            color: var(--mint-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }

        .summary-value {
            font-size: 1.1rem;
            color: var(--warm-gray-700);
            line-height: 1.7;
            font-weight: 500;
        }

        .generate-section {
            margin-top: 2.5rem;
            text-align: center;
        }

        .generate-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem 4rem;
            background: linear-gradient(135deg, 
                var(--coral-400), 
                var(--rose-400), 
                var(--lavender-400)
            );
            color: white;
            border: none;
            border-radius: var(--radius-xl);
            font-size: 1.5rem;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: var(--shadow-dreamy);
            display: none;
            letter-spacing: -0.01em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            background-size: 200% 200%;
            animation: btnShimmer 3s ease infinite;
        }

        @keyframes btnShimmer {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .generate-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.8s;
        }

        .generate-btn:hover::before {
            left: 100%;
        }

        .generate-btn:hover {
            transform: translateY(-6px) scale(1.05);
            box-shadow: 0 32px 64px rgba(251, 146, 60, 0.5);
        }

        .generate-btn:active {
            transform: translateY(-3px) scale(1.02);
        }

        .loading-section,
        .error-section,
        .story-section {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: var(--radius-xl);
            margin-top: 2.5rem;
            box-shadow: var(--shadow-large);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .loading-section {
            padding: 5rem 2rem;
            text-align: center;
            display: none;
        }

        .spinner {
            width: 4rem;
            height: 4rem;
            border: 4px solid var(--lavender-200);
            border-top: 4px solid var(--lavender-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.4rem;
            color: var(--lavender-600);
            font-weight: 700;
        }

        .error-section {
            padding: 2.5rem;
            display: none;
        }

        .error-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--rose-600);
            margin-bottom: 1rem;
        }

        .story-section {
            padding: 4rem;
            display: none;
        }

        .story-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--coral-600);
            margin-bottom: 2.5rem;
            text-align: center;
            letter-spacing: -0.02em;
        }

        .story-content {
            font-size: 1.2rem;
            line-height: 2;
            color: var(--warm-gray-700);
            background: rgba(255, 253, 247, 0.8);
            padding: 3rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-soft);
            border-left: 8px solid var(--coral-400);
        }

        .story-content p {
            margin-bottom: 2rem;
        }

        .story-content p:last-child {
            margin-bottom: 0;
        }

        @media (min-width: 768px) {
            .summary-section,
            .generate-section,
            .loading-section,
            .error-section,
            .story-section {
                grid-column: 1 / -1;
            }
        }

        @media (max-width: 767px) {
            .header h1 {
                font-size: 2.8rem;
            }
            
            .generate-btn {
                padding: 1.5rem 2.5rem;
                font-size: 1.2rem;
            }

            .floating-orb {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- Floating Blur Orbs -->
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>
    <div class="floating-orb orb-4"></div>

    <div class="app">
        <header class="header">
            <div class="header-inner">
                <h1><img src="assets/icons/logo.png" alt="Logo" style="width: 2rem; height: 2rem; margin-right: 0.5rem; vertical-align: middle;">Bedtime Stories</h1>
                <p>Create magical bedtime adventures by choosing your favorite character, setting, and life lesson</p>
            </div>
        </header>

        <main class="main-content">
            <section class="section characters">
                <div class="section-inner">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span class="section-icon">üëë</span>
                            Choose Your Hero
                        </h2>
                        <button class="refresh-btn" onclick="loadCharacters()">
                            <span>üîÑ</span>
                            New Heroes
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="characters-container" class="options-grid">
                            <div class="loading-state">Finding amazing heroes...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section settings">
                <div class="section-inner">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span class="section-icon">üè∞</span>
                            Pick Adventure Land
                        </h2>
                        <button class="refresh-btn" onclick="loadSettings()">
                            <span>üîÑ</span>
                            New Places
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="settings-container" class="options-grid">
                            <div class="loading-state">Discovering magical places...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section lessons">
                <div class="section-inner">
                    <div class="section-header">
                        <h2 class="section-title">
                            <span class="section-icon">üí´</span>
                            Choose Life Lesson
                        </h2>
                        <button class="refresh-btn" onclick="loadLessons()">
                            <span>üîÑ</span>
                            New Wisdom
                        </button>
                    </div>
                    <div class="section-content">
                        <div id="lessons-container" class="options-grid">
                            <div class="loading-state">Gathering wise lessons...</div>
                        </div>
                    </div>
                </div>
            </section>

            <section class="summary-section" id="summary">
                <h3 class="summary-title">üåü Your Story Recipe</h3>
                <div class="summary-grid">
                    <div class="summary-item">
                        <div class="summary-label">üìñ Hero</div>
                        <div class="summary-value" id="selected-character">Choose your hero above</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">üó∫Ô∏è Adventure Land</div>
                        <div class="summary-value" id="selected-setting">Pick a magical place</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">‚ú® Life Lesson</div>
                        <div class="summary-value" id="selected-lesson">Select wisdom to share</div>
                    </div>
                </div>
            </section>

            <div class="generate-section">
                <button class="generate-btn" id="generate-btn" onclick="generateStory()">
                    <span>üé≠</span>
                    Create Our Story
                </button>
            </div>

            <section class="loading-section" id="loading">
                <div class="spinner"></div>
                <div class="loading-text">Crafting your magical story...</div>
            </section>

            <section class="error-section" id="error">
                <div class="error-title">Oh no! Something went wrong</div>
                <div class="error-message" id="error-message"></div>
            </section>

            <section class="story-section" id="story">
                <h3 class="story-title">
                    <img src="assets/icons/logo.png" alt="Story" style="width: 1.5rem; height: 1.5rem; margin-right: 0.5rem; vertical-align: middle;">
                    Your Bedtime Story
                </h3>
                <div class="story-content" id="story-content"></div>
            </section>
        </main>
    </div>

    <script>
        let selectedComponents = {
            character: null,
            setting: null,
            lesson: null
        };

        const characterIcons = [
            'knight.png', 'dragon.png', 'black-cat.png', 'corgi.png', 
            'robot.png', 'princess.png', 'panda.png', 'astronaut.png'
        ];

        const settingIcons = [
            'space.png', 'sakura.png', 'forest.png', 'snow-avalanche.png',
            'autumn.png', 'river.png', 'camping.png', 'lighthouse.png', 'beach.png'
        ];

        function getRandomIcon(iconArray, folder) {
            const randomIndex = Math.floor(Math.random() * iconArray.length);
            return `assets/icons/${folder}/${iconArray[randomIndex]}`;
        }

        function setRandomIcons() {
            // Set random character icon
            const characterIcon = getRandomIcon(characterIcons, 'character');
            document.querySelector('.characters .section-icon').innerHTML = `<img src="${characterIcon}" alt="Character">`;

            // Set random setting icon
            const settingIcon = getRandomIcon(settingIcons, 'setting');
            document.querySelector('.settings .section-icon').innerHTML = `<img src="${settingIcon}" alt="Setting">`;

            // Set lesson icon (fixed)
            document.querySelector('.lessons .section-icon').innerHTML = `<img src="assets/icons/lesson/rating.png" alt="Lesson">`;

            // Set refresh button icons
            document.querySelectorAll('.refresh-btn span').forEach(span => {
                span.innerHTML = `<img src="assets/icons/refresh.png" alt="Refresh">`;
            });
        }

        function selectComponent(type, value, element) {
            // Remove selection from siblings
            const container = element.parentElement;
            container.querySelectorAll('.option-card').forEach(card => {
                card.classList.remove('selected');
            });

            // Add selection to clicked element
            element.classList.add('selected');

            // Update selected components
            selectedComponents[type] = value;
            document.getElementById(`selected-${type}`).textContent = value;

            // Update section background colors
            updateSectionBackground(type);

            // Update UI
            updateUI();
        }

        function updateSectionBackground(type) {
            const section = document.querySelector(`.${type}s`);
            if (section) {
                // Add a selected class to change the background
                section.classList.add('has-selection');
            }
        }

        function updateUI() {
            const allSelected = selectedComponents.character && 
                              selectedComponents.setting && 
                              selectedComponents.lesson;

            const summary = document.getElementById('summary');
            const generateBtn = document.getElementById('generate-btn');

            if (allSelected) {
                summary.style.display = 'block';
                generateBtn.style.display = 'inline-flex';
                
                // Smooth scroll to summary after a brief delay
                setTimeout(() => {
                    summary.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                }, 300);
            } else {
                summary.style.display = 'none';
                generateBtn.style.display = 'none';
            }
        }

        async function loadCharacters() {
            const container = document.getElementById('characters-container');
            container.innerHTML = '<div class="loading-state">Finding new heroes...</div>';

            try {
                const response = await fetch('/api/generate-characters');
                const data = await response.json();

                container.innerHTML = data.characters.map(character => 
                    `<div class="option-card" onclick="selectComponent('character', \`${character.replace(/`/g, '\\`')}\`, this)">
                        ${character}
                    </div>`
                ).join('');

            } catch (error) {
                console.error('Error loading characters:', error);
                container.innerHTML = '<div class="loading-state" style="color: var(--rose-500);">Couldn\'t find heroes right now</div>';
            }
        }

        async function loadSettings() {
            const container = document.getElementById('settings-container');
            container.innerHTML = '<div class="loading-state">Exploring new places...</div>';

            try {
                const response = await fetch('/api/generate-settings');
                const data = await response.json();

                container.innerHTML = data.settings.map(setting => 
                    `<div class="option-card" onclick="selectComponent('setting', \`${setting.replace(/`/g, '\\`')}\`, this)">
                        ${setting}
                    </div>`
                ).join('');

            } catch (error) {
                console.error('Error loading settings:', error);
                container.innerHTML = '<div class="loading-state" style="color: var(--rose-500);">Couldn\'t explore places right now</div>';
            }
        }

        async function loadLessons() {
            const container = document.getElementById('lessons-container');
            container.innerHTML = '<div class="loading-state">Gathering wisdom...</div>';

            try {
                const response = await fetch('/api/generate-lessons');
                const data = await response.json();

                container.innerHTML = data.lessons.map(lesson => 
                    `<div class="option-card" onclick="selectComponent('lesson', \`${lesson.replace(/`/g, '\\`')}\`, this)">
                        ${lesson}
                    </div>`
                ).join('');

            } catch (error) {
                console.error('Error loading lessons:', error);
                container.innerHTML = '<div class="loading-state" style="color: var(--rose-500);">Couldn\'t gather lessons right now</div>';
            }
        }

        async function generateStory() {
            if (!selectedComponents.character || !selectedComponents.setting || !selectedComponents.lesson) {
                return;
            }

            // Show loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('story').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('generate-btn').disabled = true;

            // Scroll to loading
            setTimeout(() => {
                document.getElementById('loading').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }, 150);

            try {
                const response = await fetch('/api/generate-story', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ components: selectedComponents })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate story');
                }

                const data = await response.json();

                // Hide loading, show story
                document.getElementById('loading').style.display = 'none';
                
                const storyContent = document.getElementById('story-content');
                const paragraphs = data.story.split('\n\n').map(p => p.trim()).filter(p => p);
                storyContent.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
                
                document.getElementById('story').style.display = 'block';

                // Scroll to story
                setTimeout(() => {
                    document.getElementById('story').scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                }, 300);

            } catch (error) {
                console.error('Error generating story:', error);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error-message').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            }

            document.getElementById('generate-btn').disabled = false;
        }

        // Load components on page load
        window.addEventListener('load', () => {
            setRandomIcons();
            loadCharacters();
            loadSettings();
            loadLessons();
        });
    </script>
</body>
</html>